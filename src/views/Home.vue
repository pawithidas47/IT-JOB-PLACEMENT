<template>
  <div>
    <!-- Navbar -->
    <div class="nav-wrapper">
      <span class="brand-title">IT job placement @Mor-Nor</span>
      <div class="nav-top-right">
        <router-link to="/" class="top-link" exact-active-class="active-link">‡∏´‡∏≤‡∏á‡∏≤‡∏ô</router-link>
        <router-link to="/login" class="top-link" exact-active-class="active-link">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</router-link>
        <router-link to="/register/employer" class="top-link" exact-active-class="active-link">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á</router-link>
      </div>
    </div>

    <!-- Main Layout -->
    <div class="container-fluid px-4 py-4">
      <div class="main-layout align-items-start">
        <!-- Sidebar Filter -->
        <aside class="filter-panel shadow-popup text-start bg-white" style="padding: 24px; border-radius: 12px; width: 260px; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);">
          <form class="d-flex flex-column gap-3" @submit.prevent="searchJobs">
            <!-- ‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô -->
            <div>
              <label class="form-label mb-1 fw-semibold text-dark">‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</label>
              <div class="position-relative">
                <input v-model="filter.title" @input="searchJobs" type="text" class="form-control ps-4" placeholder="  ‡πÄ‡∏ä‡πà‡∏ô ‡∏á‡∏≤‡∏ô‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö" style="border-radius: 10px; height: 38px; font-size: 14px;" />
                <span class="position-absolute top-50 start-0 translate-middle-y ms-2 text-muted">
                  <i class="bi bi-search"></i>
                </span>
              </div>
            </div>
            <!-- ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô -->
            <div>
              <label class="form-label mb-1 fw-semibold text-dark">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô</label>
              <select v-model="filter.type" @change="searchJobs" class="form-select" style="border-radius: 10px; height: 38px; font-size: 14px;">
                <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                <option value="‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡∏°‡∏±‡∏•‡∏ï‡∏¥‡∏°‡∏µ‡πÄ‡∏î‡∏µ‡∏¢">‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡∏°‡∏±‡∏•‡∏ï‡∏¥‡∏°‡∏µ‡πÄ‡∏î‡∏µ‡∏¢</option>
                <option value="‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•">‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•</option>
                <option value="‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå">‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå</option>
                <option value="UX/UI Design">UX/UI Design</option>
                <option value="IT Support">IT Support</option>
                <option value="‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢">‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢</option>
                <option value="‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°/‡πÅ‡∏õ‡∏•‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ">‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô/‡πÅ‡∏õ‡∏•‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ</option>
                <option value="‡∏Ñ‡∏µ‡∏¢‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• / Data Entry">‡∏Ñ‡∏µ‡∏¢‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• / Data Entry</option>
                <option value="‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏û‡∏à / ‡∏î‡∏π‡πÅ‡∏•‡πÇ‡∏ã‡πÄ‡∏ä‡∏µ‡∏¢‡∏•‡∏°‡∏µ‡πÄ‡∏î‡∏µ‡∏¢">‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏û‡∏à / ‡πÇ‡∏ã‡πÄ‡∏ä‡∏µ‡∏¢‡∏•‡∏°‡∏µ‡πÄ‡∏î‡∏µ‡∏¢</option>
                <option value="‡∏ï‡∏±‡∏î‡∏ï‡πà‡∏≠‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ / ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡∏ï‡πå">‡∏ï‡∏±‡∏î‡∏ï‡πà‡∏≠‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ / ‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡∏ï‡πå</option>
                <option value="‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ">‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ</option>
              </select>
            </div>
            <!-- ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á -->
            <div>
              <label class="form-label mb-1 fw-semibold text-dark">‡∏ä‡πà‡∏ß‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
              <select v-model="filter.salary" @change="searchJobs" class="form-select mb-2" style="border-radius: 10px; height: 38px; font-size: 14px;">
                <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                <option value="500">‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 500</option>
                <option value="1500">501 - 1,500</option>
                <option value="3000">1,501 - 3,000</option>
                <option value="5000">‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 3,000</option>
              </select>
            </div>
            <!-- ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á -->
            <div>
              <label class="form-label mb-1 fw-semibold text-dark">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á</label>
              <select v-model="filter.employerType" @change="searchJobs" class="form-select mb-2" style="border-radius: 10px; height: 38px; font-size: 14px;">
                <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                <option value="‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó">‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</option>
    <option value="‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</option>
    <option value="‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏†‡∏≤‡∏Ñ‡∏£‡∏±‡∏ê">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏†‡∏≤‡∏Ñ‡∏£‡∏±‡∏ê</option>
    <option value="‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏ß‡∏á‡∏´‡∏≤‡∏Å‡∏≥‡πÑ‡∏£">‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏ß‡∏á‡∏´‡∏≤‡∏Å‡∏≥‡πÑ‡∏£</option>
    <option value="‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ">‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
    <option value="‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤">‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</option>
    <option value="‡∏™‡∏ï‡∏≤‡∏£‡πå‡∏ó‡∏≠‡∏±‡∏õ">‡∏™‡∏ï‡∏≤‡∏£‡πå‡∏ó‡∏≠‡∏±‡∏õ</option>
    <option value="‡∏ü‡∏£‡∏µ‡πÅ‡∏•‡∏ô‡∏ã‡πå">‡∏ü‡∏£‡∏µ‡πÅ‡∏•‡∏ô‡∏ã‡πå</option>
              </select>
            </div>
            <!-- ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö -->
            <div>
              <label class="form-label mb-1 fw-semibold text-dark">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö</label>
              <select v-model="filter.sort" @change="searchJobs" class="form-select mb-2" style="border-radius: 10px; height: 38px; font-size: 14px;">
                <option value="">‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏á</option>
                <option value="latest">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</option>
                <option value="salary">‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</option>
                <option value="deadline">‡∏´‡∏°‡∏î‡πÄ‡∏Ç‡∏ï‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</option>
              </select>
            </div>
            <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ -->
                <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ -->
            <div class="text-center">
              <button class="btn text-white fw-bold" style="width: 100%; background: linear-gradient(135deg,#ff6600,#e55d00); border-radius: 10px; height: 40px; font-size: 14px; box-shadow: 0 2px 10px rgba(255, 102, 0, 0.3);" type="submit">
                ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
              </button>
            </div>
          </form>
        </aside>

        <!-- Divider Line -->
        <div class="vertical-divider"></div>

        <!-- Job Results -->
        <section class="job-results">
          <h5 class="mb-4 text-orange">‡∏û‡∏ö {{ filteredJobs.length }} ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏á‡∏≤‡∏ô</h5>
          <div class="job-grid">
            <div class="job-card p-4 bg-white border rounded-3 shadow-sm position-relative" v-for="job in filteredJobs" :key="job.job_id">
              <span class="badge bg-warning text-dark position-absolute top-0 end-0 mt-2 me-2" style="font-size: 0.75rem;">‡πÉ‡∏´‡∏°‡πà</span>
              <h6 class="fw-bold text-orange mb-2">
                <i class="bi bi-briefcase-fill me-2"></i> {{ job.j_title }}
              </h6>
              <p class="mb-1 text-muted"><i class="bi bi-tags-fill me-1"></i> ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô: {{ job.j_type }}</p>
              <p class="mb-1 text-muted"><i class="bi bi-cash-coin me-1"></i> ‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á: {{ job.j_salary.toLocaleString() }} ‡∏ö‡∏≤‡∏ó</p>
              <p class="mb-1 text-muted"><i class="bi bi-person-badge me-1"></i> ‡∏ú‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á: {{ job.employer_type || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' }}</p>
              <p class="mb-1 text-muted">
  <i class="bi bi-clock me-1"></i>
  ‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠: {{ new Date(job.j_posted_at).toLocaleDateString('th-TH') }}
</p>

              <p class="mb-1 text-muted"><i class="bi bi-calendar-event me-1"></i> ‡∏´‡∏°‡∏î‡πÄ‡∏Ç‡∏ï: {{ new Date(job.j_appdeadline).toLocaleDateString('th-TH') }}</p>
              <p class="mb-1 text-muted" v-if="job.j_description.includes('#')">
                <i class="bi bi-hash me-1"></i>
                <span v-for="tag in job.j_description.match(/#\w+/g)" :key="tag" class="badge bg-light text-secondary me-1">{{ tag }}</span>
              </p>
              <div class="d-flex justify-content-between mt-3">
                <router-link :to="`/jobs/${job.job_id}`" class="btn btn-sm btn-outline-primary rounded-pill px-3">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</router-link>
                <div v-if="isLoggedIn">
                  <button class="btn btn-sm btn-outline-secondary rounded-pill me-1" @click="shareJob(job)"><i class="bi bi-share"></i></button>
                  <button class="btn btn-sm btn-outline-secondary rounded-pill" @click="bookmarkJob(job)"><i class="bi bi-bookmark"></i></button>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>
</template>

<script>
export default {
  name: "JobHomePage",
  data() {
    return {
      isLoggedIn: localStorage.getItem("authToken") !== null,
      filter: {
        title: "",
        type: "",
        salary: "",
        employerType: "",
        sort: "",
      },
      jobs: [],
      filtered: [],
    };
  },
  computed: {
    filteredJobs() {
      return this.filtered;
    },
  },
  mounted() {
    import("axios").then(({ default: axios }) => {
      axios.get("http://localhost:3001/api/jobs")
        .then((res) => {
          this.jobs = res.data;
          this.searchJobs();
        })
        .catch((err) => {
          console.error("‚ùå ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", err);
        });
    });
  },
  methods: {
    searchJobs() {
      this.filtered = this.jobs
        .filter((job) => {
          const titleMatch = job.j_title?.toLowerCase().includes(this.filter.title.toLowerCase());
          const typeMatch = this.filter.type === "" || job.j_type === this.filter.type;
          const salaryMatch = this.filter.salary === "" || job.j_salary >= parseInt(this.filter.salary);
          const employerMatch = this.filter.employerType === "" || job.employer_type === this.filter.employerType;
          return titleMatch && typeMatch && salaryMatch && employerMatch && job.j_status === 'open';
        })
        .sort((a, b) => {
          if (this.filter.sort === "latest") return new Date(b.j_posted_at) - new Date(a.j_posted_at);
          if (this.filter.sort === "salary") return b.j_salary - a.j_salary;
          if (this.filter.sort === "deadline") return new Date(a.j_appdeadline) - new Date(b.j_appdeadline);
          return 0;
        });
    },
    shareJob(job) {
      const shareText = `‡∏î‡∏π‡∏á‡∏≤‡∏ô "${job.j_title}" ‡∏ó‡∏µ‡πà IT job placement @Mor-Nor\n${window.location.origin}/jobs/${job.job_id}`;
      if (navigator.share) {
        navigator.share({
          title: job.j_title,
          text: shareText,
          url: `${window.location.origin}/jobs/${job.job_id}`
        }).catch(err => console.warn("‚ùå ‡πÅ‡∏ä‡∏£‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", err));
      } else {
        navigator.clipboard.writeText(shareText).then(() => {
          alert("üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏á‡∏≤‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏Ñ‡∏•‡∏¥‡∏õ‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÅ‡∏•‡πâ‡∏ß!");
        });
      }
    },
    bookmarkJob(job) {
      alert(`üîñ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô: ${job.j_title}`);
    }
  },
};
</script>


<style scoped>
.nav-wrapper {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 24px;
  background-color: #fff;
  border-bottom: 4px solid #ff6600;
}

.brand-title {
  font-size: 1.5rem;
  font-weight: bold;
  color: #ff6600;
}

.nav-top-right {
  display: flex;
  gap: 20px;
}

.top-link {
  text-decoration: none;
  color: #333;
  font-weight: 500;
  position: relative;
}

.top-link::after {
  content: "";
  position: absolute;
  bottom: -4px;
  left: 50%;
  transform: translateX(-50%);
  height: 3px;
  width: 0%;
  background-color: #ff6600;
  transition: width 0.3s;
}

.top-link:hover::after,
.active-link::after {
  width: 60%;
}

.text-orange {
  color: #ff6600;
}

.main-layout {
  display: flex;
  gap: 2rem;
  align-items: stretch;
}

.filter-panel {
  width: 320px;
  background: white;
  border: none;
  min-height: auto;
}

.shadow-popup {
  box-shadow: 0 0 30px rgba(0, 0, 0, 0.1);
}

.vertical-divider {
  width: 2px;
  background-color: #000;
  opacity: 0.1;
  height: auto;
  align-self: stretch;
}

.job-results {
  flex: 1;
}

.job-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 20px;
}

.job-card {
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.job-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 6px 24px rgba(255, 102, 0, 0.2);
}

select,
input.form-control {
  background-color: #fcfcfc;
  border-color: #ddd;
}

@media (max-width: 768px) {
  .main-layout {
    flex-direction: column;
  }

  .filter-panel {
    width: 100%;
    max-height: 600px;
    overflow-y: auto;
  }

  .vertical-divider {
    display: none;
  }
  
}
</style>