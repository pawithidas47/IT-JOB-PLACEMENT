<template> 
  <div>
    <NavbarEmployer />
    <div class="container py-5" style="max-width: 700px">
      <h4 class="fw-bold text-orange mb-4">
        <i class="bi bi-pencil-square me-2"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á
      </h4>

      <div class="text-center mb-4">
        <img
          :src="tempPreview || imageUrl"
          class="rounded-circle border"
          style="width:130px;height:130px;object-fit:cover"
          alt="‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå"
        />
        <div class="mt-2">
          <input type="file" @change="onPickImage" accept="image/*" />
        </div>
      </div>

      <form @submit.prevent="submitForm">
        <div class="mb-3">
          <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</label>
          <input type="text" v-model="tempForm.e_company_name" class="form-control" required />
        </div>

        <div class="mb-3">
          <label class="form-label">‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</label>
          <input type="text" v-model="tempForm.e_contact" class="form-control" />
        </div>

        <div class="mb-3">
          <label class="form-label">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</label>
          <input type="text" v-model="tempForm.e_position" class="form-control" />
        </div>

        <div class="mb-3">
          <label class="form-label">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
          <input type="email" v-model="tempForm.e_email" class="form-control" required />
        </div>

        <div class="mb-3">
          <label class="form-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
          <input type="text" v-model="tempForm.e_phone" class="form-control" />
        </div>

        <div class="mb-3">
          <label class="form-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á</label>
          <select v-model="tempForm.e_type" class="form-select">
            <option value="‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó">‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</option>
            <option value="‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</option>
            <option value="‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ">‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
            <option value="‡∏™‡∏ñ‡∏≤‡∏ö‡∏±‡∏ô‡∏®‡∏∂‡∏Å‡∏©‡∏≤">‡∏™‡∏ñ‡∏≤‡∏ö‡∏±‡∏ô‡∏®‡∏∂‡∏Å‡∏©‡∏≤</option>
            <option value="‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏ß‡∏á‡∏´‡∏≤‡∏Å‡∏≥‡πÑ‡∏£">‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏ß‡∏á‡∏´‡∏≤‡∏Å‡∏≥‡πÑ‡∏£</option>
          </select>
        </div>

        <div class="d-flex gap-2">
          <button type="button" class="btn btn-outline-secondary w-50" @click="cancelEdit">
            ‚úñÔ∏è ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
          </button>
          <button type="submit" class="btn btn-orange w-50">
            üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
          </button>
        </div>
      </form>
    </div>
  </div>
</template>

<script>
import NavbarEmployer from "@/components/NavbarEmployer.vue";
import axios from "axios";
import defaultProfile from "@/assets/default-profile.png";

const BASE = "http://localhost:3001";

export default {
  components: { NavbarEmployer },
  data() {
    return {
      // ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å DB
      form: {
        e_company_name: "",
        e_contact: "",
        e_position: "",
        e_email: "",
        e_phone: "",
        e_type: "",
      },
      // ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ
      tempForm: {
        e_company_name: "",
        e_contact: "",
        e_position: "",
        e_email: "",
        e_phone: "",
        e_type: "",
      },
      employerId: null,

      imageUrl: defaultProfile, // ‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß
      tempImage: null,          // ‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà
      tempPreview: null,        // ‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà
    };
  },
  async mounted() {
    const user = JSON.parse(localStorage.getItem("user"));
    if (!user) return this.$router.push("/login");
    this.employerId = user.employer_id;
    await this.fetchProfile();
  },
  methods: {
    async fetchProfile() {
      try {
        const { data } = await axios.get(`${BASE}/api/employer/${this.employerId}`);

        this.form = {
          e_company_name: data.e_company_name || "",
          e_contact     : data.e_contact      || "",
          e_position    : data.e_position     || "",
          e_email       : data.e_email        || "",
          e_phone       : data.e_phone        || "",
          e_type        : data.e_type         || "",
        };
        this.tempForm = JSON.parse(JSON.stringify(this.form));
        this.imageUrl = data.profile_img_url ? `${BASE}${data.profile_img_url}` : defaultProfile;
        this.tempImage = null;
        this.tempPreview = null;
      } catch (err) {
        console.error("‚ùå ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", err);
      }
    },

    onPickImage(e) {
      const file = e.target.files?.[0];
      if (!file) return;
      this.tempImage = file;
      this.tempPreview = URL.createObjectURL(file);
    },

    async submitForm() {
      try {
        // 1) ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠
        await axios.put(`${BASE}/api/employer/${this.employerId}`, this.tempForm);

        // 2) ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏´‡∏≤‡∏Å‡∏°‡∏µ
        if (this.tempImage) {
          const fd = new FormData();
          fd.append("profile", this.tempImage);
          const res = await axios.post(`${BASE}/api/upload-profile-employer/${this.employerId}`, fd);
          if (res.data?.url) this.imageUrl = `${BASE}${res.data.url}?v=${Date.now()}`;
        }

        // 3) sync temp -> form ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï localStorage (‡∏´‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
        this.form = JSON.parse(JSON.stringify(this.tempForm));
        const u = JSON.parse(localStorage.getItem("user") || "{}");
        u.e_company_name = this.form.e_company_name;
        localStorage.setItem("user", JSON.stringify(u));

        this.tempImage = null;
        this.tempPreview = null;

        alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        this.$router.push("/employer/profile");
      } catch (err) {
        console.error("‚ùå ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", err);
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
      }
    },

    cancelEdit() {
      // ‚ùå ‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‚Äî ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
      this.tempForm = JSON.parse(JSON.stringify(this.form));
      this.tempImage = null;
      this.tempPreview = null;

      // ‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß: ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡∏≠‡∏≤‡∏à‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å localStorage
      const u = JSON.parse(localStorage.getItem("user") || "{}");
      u.e_company_name = this.form.e_company_name;
      localStorage.setItem("user", JSON.stringify(u));

      this.$router.push("/employer/profile");
    },
  },
};
</script>

<style scoped>
.text-orange { color:#ff6600; }
.btn-orange { background:#ff6600; color:#fff; font-weight:500; }
.btn-orange:hover { background:#e65c00; }
</style>
